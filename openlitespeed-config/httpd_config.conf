# OpenLiteSpeed Configuration for MERN Authentication App
# This is a basic configuration for serving a MERN application

serverName              example.com
user                    www-data
group                   www-data
priority                0
inMemBufSize            60M
swappingDir             /tmp/lshttpd/swap
autoFix503              1
gracefulRestartTimeout  300
mime                    conf/mime.properties
showVersionNumber       0
adminEmails             admin@example.com
adminRoot               $SERVER_ROOT/admin/
logging                 {
  logLevel              DEBUG
  logFile                $SERVER_ROOT/logs/error.log
  logFormat              "%{time} [%{level}] %{message}"
  keepDays               30
}

accessLog               {
  logFormat              "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\""
  logFile                $SERVER_ROOT/logs/access.log
  keepDays               30
}

expires                 {
  enableExpires          1
  expiresByType          image/*=A604800,text/css=A604800,application/javascript=A604800
}

tuning                  {
  maxConnections         1000
  maxSSLConnections      500
  connTimeout            300
  maxKeepAliveReq        100
  keepAliveTimeout       5
  sndBufSize             0
  rcvBufSize             0
  maxReqBodySize         2047M
  maxDynRespHeaderSize   8K
  maxDynRespSize         2047M
}

# Virtual Host for MERN App
virtualHost example.com {
  vhRoot                  $SERVER_ROOT/
  configFile              $SERVER_ROOT/conf/vhconf.conf
  allowSymbolLink         1
  enableScript            1
  restrained              1
  setUIDMode              2
}

listener default {
  address                 *:80
  secure                  0
  map                     example.com
}

# Security headers
module cache {
}

module security {
  ls_security             1
}

# Node.js Application Context
context /api/ {
  location                $VH_ROOT/backend/
  allowBrowse             1
  extraHeaders            <<<END_extraHeaders
X-Frame-Options SAMEORIGIN
X-Content-Type-Options nosniff
X-XSS-Protection "1; mode=block"
Strict-Transport-Security "max-age=31536000; includeSubDomains"
END_extraHeaders

  rewrite {
    enable                  1
    rules                   <<<END_rules
RewriteRule ^/api/(.*)$ http://127.0.0.1:5000/api/$1 [P,L]
END_rules
  }
}

# Static files context for frontend
context / {
  location                $VH_ROOT/frontend/dist/
  allowBrowse             1
  indexFiles              index.html
  autoIndex               0

  expires                 {
    enableExpires          1
    expiresByType          text/css=A604800,image/*=A604800,application/javascript=A604800
  }

  rewrite {
    enable                  1
    rules                   <<<END_rules
RewriteRule ^/$ /index.html [L]
RewriteRule ^/(?!api/).*$ /index.html [L]
END_rules
  }
}
